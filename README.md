# connect-ipfilter
## Description
A rule-oriented, [Redis]-backed middleware for [Connect]/[Express] that can filter based on IP or Redis hash keys.

## Usage
#### Middleware
```javascript
var ipf = new require('connect-ipfilter')(/* options */);
/* ... */
app.use(ipf.guard);
```

**Note:** The middleware method to pass to app.use is _guard_.

#### Defining rules
```javascript
ipf.rule({
  when: {
    key: 'failed_logins',
    is: 'gte',
    val: 5
  },
  action: function(req, res, next) {
    res.statusCode = 403;
    res.send('Forbidden');
  }
});
```

#### Manipulating Redis Keys / Request Helper
To increment a key, use the helper that is attached to the `req` object.

```javascript
app.post('/login', function(req, res, next) {
  /* ... if a login was failed ... */
  req.ipfilter.increment('failed_logins');
});
```

By default, this will be called _ipfilter_. This can be overriden by defining a _helperName_ property in the initialization options:

```javascript
var ipf = new IPFilter({helperName: 'britta'});
```

It has the _set_ and _increment_ methods from the 'record' object (which are just wrappers around the Redis commands [hset] and [hincrby], with a preset key).

> _set_ requires two parameters: a hash_key and a value.

> _increment_ requires only one: the hash_key to increment.
> It can also accept an integer to increment by, which defaults
> to 1. To decrement, just pass `-1` as the second parameter.

#### Events
If preferred, the IPFilter instance implements the EventEmitter API, and `req.ipfilter` can be used to trigger.

The event's callback will receive the 'record' as its first parameter, followed by any other args that were passed to emit.

```javascript
/* define the event callback */
ipf.on('someEvent', function(record, key, value) {
  /* some validation logic to test if value is appropriate */
  record.set(key, JSON.stringify(value));
});
```

```javascript
/* in a route */
req.ipfilter.emit('someEvent', 'some_key', ['foo', 'bar', 'baz', 'quux']);
```

#### Multiple instances
**connect-ipfilter** naturally supports multiple instances, which could be useful if filtering different paths on the site is desirable.

```javascript
var IPFilter = require('connect-ipfilter')
  , admin_filter = new IPFilter(/* options */)
  , store_filter = new IPFilter(/* options */);

/* ... */

app.use('/admin', admin_filter);
app.use('/store', store_filter);
```

## API Docs
Requires [docco]. They can be generated by running `docco *.js` in the module directory, or you can just view them online [here][docs].

--------------------------------------------------
### Version

0.0.1-alpha

### Dependencies

* *redis* 0.7.2
* *lodash* ~0.5

### License

MIT

### Todo

Soon
* Tests, tests, and also tests.
* Publish to NPM

Later
* Keys with TTL

[docs]: http://dev.mouse.vc/connect-ipfilter/ "API Docs"
[docco]: https://github.com/jashkenas/docco "Docco"
[Redis]: http://redis.io "Redis"
[hset]: http://redis.io/commands/hset "HSET"
[hincrby]: http://redis.io/commands/hincrby "HINCRBY"
[Connect]: http://www.senchalabs.org/connect/ "Connect - Middleware for Node.js"
[Express]: http://expressjs.com "Express - node.js web application framework"
